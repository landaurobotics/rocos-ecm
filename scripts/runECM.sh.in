#!/bin/bash

echo "============EtherCAT Master for Robot=============="
echo "===@Author: Yang Luo                            ==="
echo "===@Create: 2021.07.17 00:05                    ==="
echo "===@Last Modified: 2021.12.16 10:17             ==="
echo "===@Ver: 0.4                                    ==="
echo "===@usage: ./runECM.sh [eni.xml] [no.]          ==="
echo "==================================================="

ETH_NUM=$(lspci -mm | grep -i 'Ethernet controller' | sed -n '1,$p' | cut -d ' ' -f 1 | awk '$1=$1' | wc -l) # confirm the number of ethernet controllers

if [ $# -lt 2 ]; then
  echo "The ${ETH_NUM}th ethernet controller will be used as default."
  INSTANCE=$(lspci -mm | grep -i 'Ethernet controller' | sed -n '$p' | cut -d ' ' -f 1 | awk '$1=$1')
else
  NUM=$2
  if [ $2 -gt $ETH_NUM ]; then
    echo "Wrong input! The The ${ETH_NUM}th ethernet controller will be used as default."
    NUM=${ETH_NUM}
  fi
  echo "The ${NUM}th ethernet controller is used."
  INSTANCE=$(lspci -mm | grep -i 'Ethernet controller' | sed -n "${NUM}p" | cut -d ' ' -f 1 | awk '$1=$1')
fi

if [ $# -lt 1 ]; then
  echo "The eni.xml will be used as default."
  ENI_FILE=eni.xml
else
  echo "The $1 is used as eni file."
  ENI_FILE="$1"
fi

# Start EcMaster
nice -20 ./@PROJECT_NAME@ -f $ENI_FILE -i8254x $INSTANCE 1 -v 3 -perf -t 0